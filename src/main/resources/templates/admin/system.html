<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} + ' - ArthSethu Admin'">System Monitoring - ArthSethu</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        
        .admin-nav {
            display: flex;
            gap: 20px;
        }
        
        .admin-nav a {
            color: #ffffff;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 5px;
            background: #333;
            transition: background 0.3s;
        }
        
        .admin-nav a:hover, .admin-nav a.active {
            background: #007bff;
        }
        
        .system-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .system-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .system-card.offline {
            border-left-color: #dc3545;
        }
        
        .system-card.warning {
            border-left-color: #ffc107;
        }
        
        .system-card h3 {
            margin: 0 0 15px 0;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .status-indicator.warning {
            background: #ffc107;
        }
        
        .system-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .system-metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #cccccc;
        }
        
        .metric-value {
            color: #ffffff;
            font-weight: bold;
        }
        
        .metric-value.good {
            color: #28a745;
        }
        
        .metric-value.warning {
            color: #ffc107;
        }
        
        .metric-value.critical {
            color: #dc3545;
        }
        
        .alerts-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .alerts-section h3 {
            margin: 0 0 20px 0;
            color: #ffffff;
        }
        
        .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #333;
        }
        
        .alert-item.critical {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        
        .alert-item.high {
            border-left: 4px solid #fd7e14;
            background: rgba(253, 126, 20, 0.1);
        }
        
        .alert-item.medium {
            border-left: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-type {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .alert-message {
            color: #cccccc;
            font-size: 14px;
        }
        
        .alert-time {
            color: #999;
            font-size: 12px;
        }
        
        .refresh-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #cccccc;
        }
        
        .auto-refresh input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        .performance-chart {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .performance-chart h3 {
            margin: 0 0 20px 0;
            color: #ffffff;
        }
        
        .last-updated {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .admin-nav {
                flex-wrap: wrap;
            }
            
            .system-grid {
                grid-template-columns: 1fr;
            }
            
            .refresh-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <h1>System Monitoring</h1>
            <nav class="admin-nav">
                <a href="/admin/dashboard">Dashboard</a>
                <a href="/admin/users">Users</a>
                <a href="/admin/system" class="active">System</a>
                <a href="/admin/revenue">Revenue</a>
                <a href="/dashboard">Back to App</a>
            </nav>
        </div>

        <!-- Error Message -->
        <div th:if="${error}" class="alert alert-danger" style="background: #dc3545; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <span th:text="${error}">Error message</span>
        </div>

        <!-- Refresh Controls -->
        <div class="refresh-controls">
            <button class="refresh-btn" onclick="refreshSystemData()">Refresh Now</button>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-refresh every 30 seconds</label>
            </div>
        </div>

        <!-- System Health Cards -->
        <div th:if="${systemHealth}" class="system-grid">
            <!-- Government API Status -->
            <div class="system-card" th:classappend="${!systemHealth.governmentApiStatus} ? 'offline' : ''">
                <h3>
                    <div class="status-indicator" th:class="${systemHealth.governmentApiStatus} ? 'status-indicator online' : 'status-indicator offline'"></div>
                    Government Data API
                </h3>
                <div class="system-metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" 
                          th:class="${systemHealth.governmentApiStatus} ? 'good' : 'critical'"
                          th:text="${systemHealth.governmentApiStatus} ? 'Online' : 'Offline'">Online</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Last Update:</span>
                    <span class="metric-value" th:text="${#temporals.format(systemHealth.governmentApiLastUpdate, 'HH:mm:ss')}">12:34:56</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Data Sources:</span>
                    <span class="metric-value">Ministry APIs</span>
                </div>
            </div>

            <!-- AI Service Status -->
            <div class="system-card" th:classappend="${!systemHealth.ollamaStatus} ? 'offline' : ''">
                <h3>
                    <div class="status-indicator" th:class="${systemHealth.ollamaStatus} ? 'status-indicator online' : 'status-indicator offline'"></div>
                    AI Service (Ollama)
                </h3>
                <div class="system-metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" 
                          th:class="${systemHealth.ollamaStatus} ? 'good' : 'critical'"
                          th:text="${systemHealth.ollamaStatus} ? 'Online' : 'Offline'">Online</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Last Check:</span>
                    <span class="metric-value" th:text="${#temporals.format(systemHealth.ollamaLastCheck, 'HH:mm:ss')}">12:34:56</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Model:</span>
                    <span class="metric-value">Llama 3.2</span>
                </div>
            </div>

            <!-- Database Status -->
            <div class="system-card" th:classappend="${!systemHealth.databaseStatus} ? 'offline' : ''">
                <h3>
                    <div class="status-indicator" th:class="${systemHealth.databaseStatus} ? 'status-indicator online' : 'status-indicator offline'"></div>
                    Database (PostgreSQL)
                </h3>
                <div class="system-metric">
                    <span class="metric-label">Status:</span>
                    <span class="metric-value" 
                          th:class="${systemHealth.databaseStatus} ? 'good' : 'critical'"
                          th:text="${systemHealth.databaseStatus} ? 'Connected' : 'Disconnected'">Connected</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Connection Pool:</span>
                    <span class="metric-value good">Active</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Type:</span>
                    <span class="metric-value">PostgreSQL</span>
                </div>
            </div>

            <!-- System Performance -->
            <div class="system-card" th:classappend="${systemHealth.systemLoad > 0.8} ? 'warning' : ''">
                <h3>
                    <div class="status-indicator" th:class="${systemHealth.systemLoad > 0.8} ? 'status-indicator warning' : 'status-indicator online'"></div>
                    System Performance
                </h3>
                <div class="system-metric">
                    <span class="metric-label">CPU Load:</span>
                    <span class="metric-value" 
                          th:class="${systemHealth.systemLoad > 0.8} ? 'warning' : (${systemHealth.systemLoad > 0.5} ? 'warning' : 'good')"
                          th:text="${#numbers.formatDecimal(systemHealth.systemLoad, 1, 2)}">0.45</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">Memory Usage:</span>
                    <span class="metric-value" 
                          th:class="${systemHealth.memoryUsage > 1024} ? 'warning' : 'good'"
                          th:text="${systemHealth.memoryUsage} + ' MB'">512 MB</span>
                </div>
                <div class="system-metric">
                    <span class="metric-label">JVM Status:</span>
                    <span class="metric-value good">Running</span>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="performance-chart">
            <h3>System Load Over Time</h3>
            <canvas id="performanceChart" width="400" height="200"></canvas>
        </div>

        <!-- System Alerts -->
        <div class="alerts-section">
            <h3>System Alerts</h3>
            <div th:if="${#lists.isEmpty(systemAlerts)}" style="color: #28a745; text-align: center; padding: 20px;">
                âœ“ All systems operational - No alerts
            </div>
            <div th:each="alert : ${systemAlerts}" 
                 class="alert-item" 
                 th:classappend="${alert.severity.toLowerCase()}">
                <div class="alert-content">
                    <div class="alert-type" th:text="${alert.type}">Alert Type</div>
                    <div class="alert-message" th:text="${alert.message}">Alert message</div>
                </div>
                <div class="alert-time" th:text="${#temporals.format(alert.timestamp, 'HH:mm:ss')}">12:34:56</div>
            </div>
        </div>

        <div class="last-updated">
            Last updated: <span id="lastUpdated" th:text="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:34:56</span>
        </div>
    </div>

    <script>
        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(performanceCtx, {
            type: 'line',
            data: {
                labels: generateTimeLabels(),
                datasets: [{
                    label: 'CPU Load',
                    data: generateMockPerformanceData(),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Memory Usage (GB)',
                    data: generateMockMemoryData(),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1.0,
                        ticks: {
                            color: '#ffffff'
                        },
                        grid: {
                            color: '#333'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ffffff'
                        },
                        grid: {
                            color: '#333'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#ffffff'
                        }
                    }
                }
            }
        });

        function generateTimeLabels() {
            const labels = [];
            const now = new Date();
            for (let i = 29; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 60000); // 1 minute intervals
                labels.push(time.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }));
            }
            return labels;
        }

        function generateMockPerformanceData() {
            const data = [];
            const currentLoad = /*[[${systemHealth?.systemLoad ?: 0.3}]]*/ 0.3;
            for (let i = 0; i < 30; i++) {
                // Generate realistic fluctuating data around current load
                const variation = (Math.random() - 0.5) * 0.2;
                data.push(Math.max(0, Math.min(1, currentLoad + variation)));
            }
            return data;
        }

        function generateMockMemoryData() {
            const data = [];
            const currentMemory = /*[[${systemHealth?.memoryUsage ?: 512}]]*/ 512;
            const currentMemoryGB = currentMemory / 1024;
            for (let i = 0; i < 30; i++) {
                // Generate realistic fluctuating data around current memory usage
                const variation = (Math.random() - 0.5) * 0.1;
                data.push(Math.max(0, currentMemoryGB + variation));
            }
            return data;
        }

        function refreshSystemData() {
            fetch('/admin/api/system-health')
                .then(response => response.json())
                .then(data => {
                    location.reload(); // Simple refresh for now
                    updateLastUpdatedTime();
                })
                .catch(error => {
                    console.error('Error refreshing system data:', error);
                });
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = 
                now.toISOString().slice(0, 19).replace('T', ' ');
        }

        // Auto-refresh functionality
        let autoRefreshInterval;

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(refreshSystemData, 30000); // 30 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Handle auto-refresh checkbox
        document.getElementById('autoRefresh').addEventListener('change', function() {
            if (this.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // Start auto-refresh by default
        startAutoRefresh();

        // Update chart data periodically
        setInterval(() => {
            if (document.getElementById('autoRefresh').checked) {
                // Update chart with new mock data
                performanceChart.data.datasets[0].data = generateMockPerformanceData();
                performanceChart.data.datasets[1].data = generateMockMemoryData();
                performanceChart.update('none'); // Update without animation
            }
        }, 10000); // Update chart every 10 seconds
    </script>
</body>
</html>